<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start! AI小車初賽 - 大型計時器與錄影儲存</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: all 0.3s ease;
            position: relative;
            padding: 20px;
        }
        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            padding: 10px;
            border-radius: 8px;
            font-family: sans-serif;
        }
        [contenteditable]:focus { outline: none; }
        
        #display, #modalDisplay {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .digit { display: inline-block; text-align: center; min-width: 1.1ch; }
        .separator { display: inline-block; text-align: center; min-width: 0.5ch; }

        /* 經典主題 */
        body.theme-original {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        body.theme-original .card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        body.theme-original #display, body.theme-original #modalDisplay { font-family: 'Courier New', monospace; color: #0f172a; }
        body.theme-original #themeSelect { color: #1e293b; }
        body.theme-original .modal-content-bg { background: white; border: 1px solid #cbd5e1; }
        body.theme-original #modalTitle { color: #1e293b; }

        /* 科幻主題 */
        body.theme-scifi {
            background-color: #000814;
            color: white;
            font-family: 'Orbitron', sans-serif;
            background-image: linear-gradient(rgba(0, 53, 102, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 53, 102, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        body.theme-scifi .card { background: rgba(0, 29, 61, 0.8); border: 1px solid #ffc300; box-shadow: 0 0 15px rgba(255, 195, 0, 0.2); }
        body.theme-scifi #display, body.theme-scifi #modalDisplay { color: #ffffff; text-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 0 10px #ffc300; }
        body.theme-scifi .header-title { color: #ffc300; text-shadow: 0 0 15px rgba(255, 195, 0, 0.6); }
        body.theme-scifi #themeSelect { color: white; }
        body.theme-scifi #themeSelect option { background: #001d3d; color: white; }
        body.theme-scifi .modal-content-bg { background: #001d3d; border: 1px solid #ffc300; }
        body.theme-scifi #modalTitle { color: #ffc300; }

        .finished { animation: pulse 1s infinite; color: #ef4444 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }

        #videoPreview, #modalVideo {
            width: 100%;
            max-width: 480px;
            border-radius: 12px;
            background: #000;
        }
        .mirror { transform: scaleX(-1); }
        .recording-dot {
            width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%;
            display: inline-block; margin-right: 8px; animation: blink 1s infinite;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="theme-original">

    <div class="theme-switcher card p-2 flex items-center gap-2 shadow-lg">
        <label class="text-xs font-bold text-slate-500">主題：</label>
        <select id="themeSelect" onchange="changeTheme(this.value)" class="bg-transparent border border-slate-400 rounded px-1 outline-none text-sm">
            <option value="theme-original">經典樣式</option>
            <option value="theme-scifi">科幻主題</option>
        </select>
    </div>

    <div class="max-w-6xl w-full flex flex-col items-center gap-8 mt-10 mb-20">
        <div class="text-center">
            <h1 id="mainTitle" contenteditable="true" class="header-title text-4xl md:text-6xl font-black px-4 py-2 transition-all cursor-text mb-4 inline-block">碼錶1</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full">
            <div class="lg:col-span-2 card rounded-3xl p-6 md:p-10 flex flex-col items-center justify-center min-h-[400px]">
                
                <div class="relative w-full flex flex-col items-center mb-6">
                    <div id="recordingStatus" class="absolute top-2 left-2 bg-black/50 px-3 py-1 rounded-full text-xs font-bold hidden flex items-center text-white z-10">
                        <span class="recording-dot"></span> REC
                    </div>
                    <button id="flipBtn" onclick="switchCamera()" class="absolute top-2 right-2 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white z-10 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <canvas id="recordCanvas" class="hidden"></canvas>
                    <video id="videoPreview" autoplay muted playsinline class="mirror shadow-xl"></video>
                </div>

                <div class="flex items-center gap-3 mb-6 bg-slate-800/20 px-4 py-2 rounded-full border border-slate-700/30">
                    <span class="text-sm font-bold opacity-70">同步模式 (單一控制)</span>
                    <label class="switch">
                        <input type="checkbox" id="syncModeToggle" onchange="toggleUIMode()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="display" class="text-6xl md:text-8xl font-bold mb-12">
                    <span class="digit">0</span><span class="digit">0</span>
                    <span class="separator">:</span>
                    <span class="digit">0</span><span class="digit">0</span>
                    <span class="separator">.</span>
                    <span class="digit">0</span><span class="digit">0</span><span class="digit">0</span>
                </div>

                <div class="flex flex-col gap-6 w-full items-center">
                    <!-- 一般模式控制 -->
                    <div id="manualControls" class="flex flex-col gap-6 w-full items-center">
                        <div class="flex flex-wrap justify-center gap-4 w-full border-b border-slate-700/30 pb-6 text-black">
                            <div class="w-full text-center text-xs font-bold opacity-50 mb-1">計時控制</div>
                            <button id="timerStartBtn" onclick="toggleTimer()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg min-w-[140px]">開始計時</button>
                            <button id="resetBtn" onclick="resetTimer()" class="bg-slate-500 hover:bg-slate-400 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg">計時歸零</button>
                        </div>
                        
                        <div class="flex flex-wrap justify-center gap-4 w-full">
                            <div class="w-full text-center text-xs font-bold opacity-50 mb-1">錄影控制</div>
                            <button id="recStartBtn" onclick="startRecording()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg min-w-[140px] disabled:opacity-30 disabled:pointer-events-none">開始錄影</button>
                            <button id="recStopBtn" onclick="stopRecording()" disabled class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg disabled:opacity-30 disabled:pointer-events-none min-w-[140px]">停止錄影</button>
                        </div>
                    </div>

                    <!-- 同步模式控制 -->
                    <div id="syncControls" class="hidden flex flex-wrap justify-center gap-4 w-full">
                        <button id="syncStartBtn" onclick="syncStart()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-12 py-4 rounded-xl font-bold text-xl transition-all active:scale-95 shadow-lg min-w-[180px] disabled:opacity-30 disabled:pointer-events-none">開始 (錄影+計時)</button>
                        <button id="syncStopBtn" onclick="syncStop()" disabled class="bg-red-600 hover:bg-red-500 text-white px-12 py-4 rounded-xl font-bold text-xl transition-all active:scale-95 shadow-lg disabled:opacity-30 disabled:pointer-events-none min-w-[180px]">停止並儲存</button>
                        <button id="syncResetBtn" onclick="resetTimer()" class="bg-slate-500 hover:bg-slate-400 text-white px-12 py-4 rounded-xl font-bold text-xl transition-all active:scale-95 shadow-lg min-w-[180px]">歸零</button>
                    </div>
                </div>
            </div>

            <div class="card rounded-3xl p-6 flex flex-col">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    已存紀錄 (點擊播放)
                </h2>
                <div id="recordList" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 max-h-[550px] pr-2">
                    <div class="text-center py-10 opacity-30 italic text-sm text-slate-400">尚無紀錄</div>
                </div>
            </div>
        </div>
    </div>

    <div id="playbackModal" class="modal-overlay">
        <div class="modal-content-bg p-6 rounded-3xl max-w-2xl w-full flex flex-col items-center shadow-2xl relative">
            <div class="absolute top-4 right-4 flex gap-2 text-black">
                <button id="modalDownloadBtn" class="text-slate-400 hover:text-blue-400 transition-colors" title="下載影片">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <h3 id="modalTitle" class="text-xl font-bold mb-4">回放中...</h3>
            <video id="modalVideo" controls class="mb-6 shadow-2xl"></video>
            <div id="modalDisplay" class="text-5xl md:text-7xl font-bold mb-4">
                <span class="digit">0</span><span class="digit">0</span>
                <span class="separator">:</span>
                <span class="digit">0</span><span class="digit">0</span>
                <span class="separator">.</span>
                <span class="digit">0</span><span class="digit">0</span><span class="digit">0</span>
            </div>
            <p class="text-slate-500 text-sm">影片內含合成計時器</p>
        </div>
    </div>

    <footer class="text-center py-6 text-slate-500 text-sm">
        版權所有 © 2026 <a href="https://pandapanda6666.github.io" target="_blank" class="hover:underline">PandaPanda的AI日常</a> All Rights Reserved.
    </footer>

    <script>
        let startTime, elapsedTime = 0, timerInterval, timerActive = false;
        let recordingActive = false;
        let savedRecords = JSON.parse(localStorage.getItem('savedStopwatchRecords') || '[]');
        let mediaStream, mediaRecorder, recordedChunks = [], currentFacingMode = 'user';
        let db = null;
        let supportedMimeType = '';
        let canvasStream = null;
        let isSavingToDB = false;

        const display = document.getElementById('display');
        const modalDisplay = document.getElementById('modalDisplay');
        const timerStartBtn = document.getElementById('timerStartBtn');
        const recStartBtn = document.getElementById('recStartBtn');
        const recStopBtn = document.getElementById('recStopBtn');
        const syncStartBtn = document.getElementById('syncStartBtn');
        const syncStopBtn = document.getElementById('syncStopBtn');
        const mainTitle = document.getElementById('mainTitle');
        const recordList = document.getElementById('recordList');
        const videoPreview = document.getElementById('videoPreview');
        const recordCanvas = document.getElementById('recordCanvas');
        const ctx = recordCanvas.getContext('2d');
        const recordingStatus = document.getElementById('recordingStatus');
        const playbackModal = document.getElementById('playbackModal');
        const modalVideo = document.getElementById('modalVideo');
        const modalDownloadBtn = document.getElementById('modalDownloadBtn');
        const syncModeToggle = document.getElementById('syncModeToggle');

        const getSupportedMimeType = () => {
            const types = ['video/mp4;codecs=h264,aac', 'video/mp4', 'video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm'];
            for (let type of types) { if (MediaRecorder.isTypeSupported(type)) return type; }
            return '';
        };

        const initDB = (callback) => {
            const request = indexedDB.open("StopwatchVideoDB", 1);
            request.onupgradeneeded = (e) => {
                const database = e.target.result;
                if (!database.objectStoreNames.contains("videos")) database.createObjectStore("videos", { keyPath: "id" });
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                db.onversionchange = () => { if(db) db.close(); db = null; };
                if (callback) callback();
            };
        };

        const ensureDB = (action) => { if (db) { action(); } else { initDB(() => action()); } };

        async function initCamera() {
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: true 
                });
            } catch (err) {
                try { mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false }); } catch (vErr) { return; }
            }
            videoPreview.srcObject = mediaStream;
            currentFacingMode === 'user' ? videoPreview.classList.add('mirror') : videoPreview.classList.remove('mirror');
            supportedMimeType = getSupportedMimeType();
        }

        window.onload = () => {
            initDB();
            renderRecords();
            const savedTitle = localStorage.getItem('lastStopwatchTitle');
            if (savedTitle) mainTitle.textContent = savedTitle;
            initCamera();
            requestAnimationFrame(drawMergedFrame);
        };

        mainTitle.addEventListener('blur', () => localStorage.setItem('lastStopwatchTitle', mainTitle.textContent.trim()));

        function changeTheme(themeName) { document.body.className = themeName; }

        function toggleUIMode() {
            const isSync = syncModeToggle.checked;
            document.getElementById('manualControls').classList.toggle('hidden', isSync);
            document.getElementById('syncControls').classList.toggle('hidden', !isSync);
            resetTimer();
        }

        function formatTime(time) {
            let ms = Math.floor(time % 1000);
            let ss = Math.floor((time / 1000) % 60);
            let mm = Math.floor((time / 60000) % 60);
            return {
                mm: mm.toString().padStart(2, "0"),
                ss: ss.toString().padStart(2, "0"),
                ms: ms.toString().padStart(3, "0")
            };
        }

        function updateDisplayElement(el, time) {
            const t = formatTime(time);
            el.innerHTML = `
                <span class="digit">${t.mm[0]}</span><span class="digit">${t.mm[1]}</span>
                <span class="separator">:</span>
                <span class="digit">${t.ss[0]}</span><span class="digit">${t.ss[1]}</span>
                <span class="separator">.</span>
                <span class="digit">${t.ms[0]}</span><span class="digit">${t.ms[1]}</span><span class="digit">${t.ms[2]}</span>
            `;
        }

        function switchCamera() {
            if (recordingActive) return;
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            initCamera();
        }

        function drawMergedFrame() {
            const w = recordCanvas.width || 640;
            const h = recordCanvas.height || 480;
            if (videoPreview.videoWidth > 0 && recordCanvas.width !== videoPreview.videoWidth) {
                recordCanvas.width = videoPreview.videoWidth;
                recordCanvas.height = videoPreview.videoHeight;
            }
            ctx.save();
            if (currentFacingMode === 'user') { ctx.translate(w, 0); ctx.scale(-1, 1); }
            ctx.drawImage(videoPreview, 0, 0, w, h);
            ctx.restore();

            const isScifi = document.body.classList.contains('theme-scifi');
            const fontName = isScifi ? 'Orbitron' : 'Courier New';
            const textColor = isScifi ? "#ffc300" : "#000000";
            const strokeColor = isScifi ? "#000000" : "#ffffff";

            const t = formatTime(elapsedTime);
            const timeStr = `${t.mm}:${t.ss}.${t.ms}`;
            const fontSize = Math.floor(h * 0.12);
            ctx.font = `bold ${fontSize}px ${fontName}, monospace`;
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 8;
            ctx.strokeText(timeStr, w / 2, h * 0.95);
            
            ctx.fillStyle = textColor;
            ctx.fillText(timeStr, w / 2, h * 0.95);
            requestAnimationFrame(drawMergedFrame);
        }

        function getUniqueName(originalName) {
            let name = originalName.trim();
            if (!/\d+$/.test(name)) name = name + "1";
            let finalName = name;
            while (savedRecords.some(r => r.name === finalName)) {
                const match = finalName.match(/(.*?)(\d+)$/);
                finalName = match[1] + (parseInt(match[2]) + 1);
            }
            return finalName;
        }

        function autoUpdateTitle() {
            const current = mainTitle.textContent.trim();
            const nextName = getUniqueName(current);
            mainTitle.textContent = nextName;
            localStorage.setItem('lastStopwatchTitle', nextName);
        }

        function saveRecord(id) {
            if (isSavingToDB && !id) return;
            
            const originalName = mainTitle.textContent.trim() || "碼錶";
            const finalName = getUniqueName(originalName);
            const t = formatTime(elapsedTime);
            
            const record = {
                id: id || Date.now(),
                name: finalName,
                timeStr: `${t.mm}:${t.ss}.${t.ms}`,
                totalMs: elapsedTime,
                timestamp: new Date().toLocaleString(),
                hasVideo: !!id
            };
            
            savedRecords.unshift(record);
            localStorage.setItem('savedStopwatchRecords', JSON.stringify(savedRecords));
            renderRecords();
            autoUpdateTitle();
            if (id) isSavingToDB = false;
        }

        function toggleTimer() { timerActive ? stopTimer() : startTimer(); }

        function startTimer() {
            if (timerActive) return;
            timerActive = true;
            isSavingToDB = syncModeToggle.checked && recordingActive;
            startTime = Date.now() - elapsedTime;
            display.classList.remove('finished');
            if (!syncModeToggle.checked) {
                timerStartBtn.textContent = "暫停計時";
                timerStartBtn.classList.replace('bg-green-600', 'bg-yellow-600');
            }
            
            if (!syncModeToggle.checked && !recordingActive) {
                recStartBtn.disabled = true;
            }

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplayElement(display, elapsedTime);
            }, 10);
        }

        function stopTimer() {
            if (!timerActive) return;
            timerActive = false;
            clearInterval(timerInterval);
            display.classList.add('finished');
            if (!syncModeToggle.checked) {
                timerStartBtn.textContent = "繼續計時";
                timerStartBtn.classList.replace('bg-yellow-600', 'bg-green-600');
            }
            
            if (!recordingActive && !isSavingToDB && elapsedTime > 0) {
                saveRecord(null);
            }
        }

        function resetTimer() {
            stopTimer();
            elapsedTime = 0;
            updateDisplayElement(display, 0);
            display.classList.remove('finished');
            if (!syncModeToggle.checked) {
                timerStartBtn.textContent = "開始計時";
            }
            isSavingToDB = false;
            if (!syncModeToggle.checked && !recordingActive) {
                recStartBtn.disabled = false;
            }
        }

        function startRecording() {
            if (recordingActive || !mediaStream || !supportedMimeType) return;
            try {
                recordingActive = true;
                isSavingToDB = true;
                recStartBtn.disabled = true;
                recStopBtn.disabled = false;
                document.getElementById('flipBtn').style.display = 'none';
                recordingStatus.classList.remove('hidden');

                canvasStream = recordCanvas.captureStream(25); 
                const audioTracks = mediaStream.getAudioTracks();
                if (audioTracks.length > 0) canvasStream.addTrack(audioTracks[0]);
                
                recordedChunks = [];
                const options = { videoBitsPerSecond: 1500000, mimeType: supportedMimeType };
                try { mediaRecorder = new MediaRecorder(canvasStream, options); } catch (e) { mediaRecorder = new MediaRecorder(canvasStream); }
                
                mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = async () => {
                    const finalMime = mediaRecorder.mimeType || supportedMimeType;
                    const blob = new Blob(recordedChunks, { type: finalMime });
                    const id = Date.now();
                    ensureDB(() => {
                        const transaction = db.transaction(["videos"], "readwrite");
                        transaction.objectStore("videos").add({ id: id, data: blob, mimeType: finalMime });
                        saveRecord(id);
                    });
                };
                mediaRecorder.start(1000); 
            } catch (err) { stopRecording(); }
        }

        function stopRecording() {
            if (!recordingActive) return;
            recordingActive = false;
            stopTimer();
            recStartBtn.disabled = false;
            recStopBtn.disabled = true;
            document.getElementById('flipBtn').style.display = 'block';
            recordingStatus.classList.add('hidden');
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        }

        function syncStart() {
            elapsedTime = 0;
            updateDisplayElement(display, 0);
            startRecording();
            setTimeout(startTimer, 100);
            syncStartBtn.disabled = true;
            syncStopBtn.disabled = false;
        }

        function syncStop() {
            syncStartBtn.disabled = false;
            syncStopBtn.disabled = true;
            stopRecording(); 
        }

        async function playRecord(id) {
            const record = savedRecords.find(r => r.id === id);
            if (!record || !record.hasVideo) {
                if (record && !record.hasVideo) alert("此紀錄僅有計時數據，無錄影檔案。");
                return;
            }
            ensureDB(() => {
                const request = db.transaction(["videos"], "readonly").objectStore("videos").get(id);
                request.onsuccess = () => {
                    if (request.result) {
                        const url = URL.createObjectURL(request.result.data);
                        modalVideo.src = url;
                        document.getElementById('modalTitle').textContent = record.name;
                        playbackModal.style.display = 'flex';
                        modalVideo.ontimeupdate = () => {
                            updateDisplayElement(modalDisplay, modalVideo.currentTime * 1000);
                        };
                        modalDownloadBtn.onclick = () => downloadFromBlob(request.result.data, record.name, request.result.mimeType);
                        modalVideo.play();
                    }
                };
            });
        }

        function downloadRecord(e, id) {
            e.stopPropagation();
            const record = savedRecords.find(r => r.id === id);
            if (!record.hasVideo) return;
            ensureDB(() => {
                const request = db.transaction(["videos"], "readonly").objectStore("videos").get(id);
                request.onsuccess = () => { if (request.result) downloadFromBlob(request.result.data, record.name, request.result.mimeType); };
            });
        }

        function downloadFromBlob(blob, name, mime) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const extension = (mime && mime.includes('mp4')) ? 'mp4' : 'webm';
            a.download = `${name}_${Date.now()}.${extension}`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
        }

        function closeModal() { modalVideo.pause(); modalVideo.src = ""; playbackModal.style.display = 'none'; }

        function deleteRecord(e, id) {
            e.stopPropagation();
            savedRecords = savedRecords.filter(r => r.id !== id);
            localStorage.setItem('savedStopwatchRecords', JSON.stringify(savedRecords));
            ensureDB(() => { db.transaction(["videos"], "readwrite").objectStore("videos").delete(id); renderRecords(); });
        }

        function renderRecords() {
            if (savedRecords.length === 0) {
                recordList.innerHTML = '<div class="text-center py-10 opacity-30 italic text-sm text-slate-400">尚無紀錄</div>';
                return;
            }
            recordList.innerHTML = savedRecords.map(r => `
                <div onclick="playRecord(${r.id})" class="p-4 rounded-2xl border border-slate-700/50 bg-slate-800/40 group hover:border-blue-500 hover:bg-slate-800/80 transition-all cursor-pointer text-white">
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden">
                            <div class="font-bold text-base text-blue-400 truncate">${r.name}</div>
                            <div class="text-[10px] opacity-40">${r.timestamp}</div>
                        </div>
                        <div class="flex gap-1">
                            ${r.hasVideo ? `
                            <button onclick="downloadRecord(event, ${r.id})" class="text-slate-500 hover:text-blue-400 transition-all p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </button>
                            ` : ''}
                            <button onclick="deleteRecord(event, ${r.id})" class="text-slate-500 hover:text-red-400 transition-all p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="text-2xl font-mono mt-2 font-black tracking-wider">${r.timeStr}</div>
                    <div class="mt-2 text-[10px] text-blue-500/50 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg> ${r.hasVideo ? '點擊播放 (含合成時間)' : '僅計時紀錄 (無影片)'}
                    </div>
                </div>
            `).join('');
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.id === 'mainTitle') return;
            if (e.code === 'Space') { 
                e.preventDefault(); 
                if (syncModeToggle.checked) {
                    recordingActive ? syncStop() : syncStart();
                } else {
                    toggleTimer(); 
                }
            }
            if (e.key.toLowerCase() === 'r') resetTimer();
        });
    </script>
</body>
</html>

